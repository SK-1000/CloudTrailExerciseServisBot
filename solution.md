# CloudTrail Log Analysis Methodology

## Methodology

The CloudTrail log analysis script is designed to parse AWS CloudTrail logs, identify potential security anomalies, and categorize them based on risk levels (low, medium, high). The following steps outline the methodology used in the script:

1. **AWS Cloudtrail Rampup**:
   - I used AWS document to learn about Cloudtrail logs
   - I used AWS document specifically to understand the cloudtrail file form and the meaning of each field in the json file.

1. **Company Security Policy**:
   - Read the security policy in depth and identified the anomalies that required logging 
   - Intrepretted from working on the policy the risk rating of an anomaly.


1. **Environment Setup**:
   - Load environment variables for email configuration using the `dotenv` package.
   - Set up necessary libraries, including `fs` for file operations, `path` for handling file paths, `csv-writer` for writing to CSV, `ip` for IP address validation, and `nodemailer` for sending email alerts.

2. **Configuration**:
   - Specify the folder path containing the CloudTrail log files and the output path for the CSV file.
   - Configure the email transport service for alert notifications.

3. **CSV Writer Initialization**:
   - Define the structure of the output CSV file, including headers that capture relevant event information such as event ID, time, name, risk rating, and details.

4. **Anomaly Detection**:
   - Read all JSON files in the specified folder, parsing the CloudTrail log data.
   - For each event in the logs, assess its characteristics against predefined criteria to identify potential anomalies.

5. **Risk Rating Evaluation**:
   - Implement a function to determine risk levels based on event attributes, including:
     - **Event Name**: Identifying manual deletions and IAM policy changes as high-risk.
     - **IP Address Validation**: Checking if the event originated from an approved IP address range.
     - **AWS Region Validity**: Ensuring events are from supported AWS regions.
     - **Service Approval**: Verifying if the event was generated by approved AWS services.
     - **Root User Activity**: Flagging actions taken by root users as high-risk.
     - **Failed Login Attempts**: Monitoring multiple failed logins and categorizing them as high-risk.

6. **Alert Generation**:
   - Store alerts for identified anomalies and prepare a summary for email notifications.
   - Write all anomalies to the specified CSV file.

7. **Email Notification**:
   - Send an email alert containing details of the detected anomalies.
   - These are ordered chronologically with related eventid listed together.

8. **Testing**:
   - Create a test file called cloudtrail_log_test11.json which contained some events with anomalies, some with many anomalies and some with no anomalies. Use this to test code on a smaller scale.

8. **Terminal Logging**:
   - logged total events processed, high risk events count, Medium risk events count and low risk events count as an "at a glance" statistic.


## Assumptions

1. **Log Structure**: The script assumes that the CloudTrail log files conform to the standard AWS CloudTrail JSON structure, containing an array of event records under the `Records` key.

2. **Predefined IP Ranges**: The script assumes a static list of approved IP ranges. Any event originating from an IP outside these ranges will be flagged as medium risk.

3. **Supported Regions and Services**: The script assumes that only certain AWS regions and services are acceptable for operations. Events from unsupported regions or using unapproved services are considered medium risk.

4. **Root User Activity**: It is assumed that any action taken by the root user is inherently risky and requires immediate attention.

5. **Failed Login Attempts**: The script assumes that five or more failed login attempts within a short timeframe indicate a potential security breach.


## Risk Scoring Reasoning

The risk scoring for each event is determined based on the following criteria:

1. **High Risk**:
   - Manual deletions by IAM users or root users.
   - Creation or modification of IAM policies.
   - Actions involving resources tagged as "production," especially deletions or modifications.
   - Non-compliance with encryption requirements for S3, RDS, or Elastic File System resources.
   - Activities logged from the root user.
   - Multiple failed login attempts exceeding a predefined threshold (e.g., 5 attempts).

2. **Medium Risk**:
   - Events from IP addresses outside the approved ranges.
   - Events from unsupported AWS regions.
   - Events using services not listed as approved.
   - IAM policy changes that may not be explicitly harmful but require further investigation.

3. **Low Risk**:
   - Events that do not meet any of the high or medium-risk criteria are classified as low risk and are not reported as anomalies.

4. **Risk Prioritisation**:
   - If an event has a high and medium anomaly, it will be categorised as a high risk anomaly in the outputted csv file.


This methodology provides a comprehensive framework for analyzing CloudTrail logs and identifying potential security risks, allowing organizations to take timely action to protect their AWS environments.

1. Installed Docker on my machine